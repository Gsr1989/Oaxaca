@app.route('/registro_usuario', methods=['GET', 'POST'])
def registro_usuario():
    if 'user_id' not in session:
        return redirect(url_for('login'))

    user_id = session['user_id']

    if request.method == 'POST':
        # —––– Tu lógica de lectura y guardado en Supabase —–––
        folio         = request.form['folio']
        marca         = request.form['marca']
        linea         = request.form['linea']
        anio          = request.form['anio']
        numero_serie  = request.form['serie']
        numero_motor  = request.form['motor']
        vigencia      = int(request.form['vigencia'])

        # … (validaciones, guardado en BD, actualización de folios usados) …

        # Genera el PDF y obtén la ruta
        pdf_path = generar_pdf(folio, marca, linea, anio, numero_serie, numero_motor, vigencia)

        # Verifica que realmente exista
        if not os.path.exists(pdf_path):
            flash("Error: el PDF no se generó correctamente.", "error")
            return redirect(url_for('registro_usuario'))

        # Y finalmente, envíalo al cliente:
        return send_file(
            pdf_path,
            mimetype='application/pdf',
            as_attachment=True,
            download_name=f"{folio}.pdf"    # nombre que verá el usuario
        )

    # Si es GET, muestra el formulario
    response   = supabase.table("verificaciondigitalcdmx") \
                         .select("folios_asignac, folios_usados") \
                         .eq("id", user_id).execute()
    folios_info = response.data[0] if response.data else {}
    return render_template("registro_usuario.html", folios_info=folios_info)
